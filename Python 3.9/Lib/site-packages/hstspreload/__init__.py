"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.9.1"
__checksum__ = "2c353b04a5a0b908ec702eefaf9c764d4bee133994fafeda569bc58169eb67d7"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 16), (352, 10), (362, 28), None, (390, 54), (444, 8), (452, 18), (470, 19), (489, 13), (502, 14), (516, 14), None, None, (530, 29), (559, 20), (579, 35), (614, 14), (628, 24), (652, 9), None, (661, 25), (686, 27), (713, 8), (721, 13), None, None, (734, 17), (751, 6), (757, 26), (783, 5), (788, 5), (793, 19), (812, 14), (826, 11), (837, 12), (849, 27), None, (876, 11), (887, 11), (898, 7), (905, 29), (934, 18), (952, 27), (979, 46), (1025, 25), (1050, 16), (1066, 8), (1074, 5), (1079, 22), (1101, 18), None, (1119, 36), (1155, 15), (1170, 8), (1178, 11), None, (1189, 5), (1194, 16), (1210, 14), (1224, 18), None, (1242, 14), (1256, 18), (1274, 48), (1322, 19), (1341, 12), (1353, 59), (1412, 14), (1426, 14), (1440, 20), None, (1460, 10), (1470, 13), (1483, 20), (1503, 19), None, (1522, 13), (1535, 19), (1554, 11), (1565, 4), (1569, 22), (1591, 10), (1601, 7), (1608, 14), (1622, 21), (1643, 11), (1654, 21), (1675, 12), (1687, 32), None, (1719, 10), (1729, 14), (1743, 12), (1755, 45), (1800, 15), None, (1815, 11), (1826, 23), (1849, 21), (1870, 26), (1896, 6), (1902, 6), (1908, 7), (1915, 5), (1920, 20), (1940, 23), (1963, 24), (1987, 13), (2000, 15), (2015, 19), (2034, 6), (2040, 61), (2101, 44), (2145, 12), (2157, 23), (2180, 16), (2196, 38), (2234, 6), (2240, 12), (2252, 44), (2296, 6), (2302, 41), (2343, 13), (2356, 23), (2379, 30), (2409, 16), (2425, 8), (2433, 15), (2448, 12), (2460, 19), (2479, 21), (2500, 15), None, (2515, 35), (2550, 21), (2571, 17), (2588, 19), (2607, 26), (2633, 5), (2638, 37), (2675, 30), (2705, 16), (2721, 10), (2731, 17), (2748, 23), (2771, 14), (2785, 17), (2802, 8), (2810, 8), (2818, 7), (2825, 29), (2854, 6), (2860, 18), (2878, 27), (2905, 20), (2925, 17), (2942, 19), (2961, 12), (2973, 40), (3013, 40), (3053, 12), (3065, 48), (3113, 25), (3138, 12), None, (3150, 8), (3158, 25), (3183, 19), (3202, 6), (3208, 23), None, (3231, 30), (3261, 33), (3294, 14), (3308, 16), (3324, 27), None, (3351, 26), (3377, 41), (3418, 50), (3468, 15), (3483, 20), (3503, 15), (3518, 21), (3539, 32), (3571, 24), (3595, 20), (3615, 17), (3632, 60), (3692, 19), (3711, 9), (3720, 12), (3732, 12), (3744, 11), (3755, 10), (3765, 48), (3813, 32), None, (3845, 25), (3870, 23), None, (3893, 8), (3901, 8), (3909, 7), None, (3916, 25), (3941, 17), None, (3958, 21), (3979, 35), (4014, 21), (4035, 10), (4045, 36), (4081, 20), (4101, 22), (4123, 23), (4146, 19), (4165, 12), (4177, 5), (4182, 30), (4212, 24), (4236, 14), (4250, 14), (4264, 47), (4311, 52), None, None, (4363, 51), (4414, 42), None, (4456, 14), None, (4470, 15), (4485, 8), (4493, 21), (4514, 6), (4520, 16), (4536, 17)], [(4553, 8324), (12877, 9060), (21937, 9264), (31201, 7876), (39077, 8472), (47549, 8171), (55720, 9038), (64758, 8041), (72799, 8970), (81769, 8262), (90031, 9461), (99492, 8216), (107708, 8799), (116507, 10076), (126583, 8516), (135099, 8910), (144009, 9256), (153265, 8263), (161528, 8537), (170065, 8161), (178226, 9120), (187346, 8840), (196186, 8975), (205161, 8395), (213556, 8912), (222468, 8502), (230970, 9047), (240017, 9178), (249195, 8063), (257258, 8716), (265974, 8981), (274955, 8372), (283327, 8676), (292003, 8876), (300879, 7836), (308715, 8706), (317421, 8588), (326009, 9357), (335366, 8897), (344263, 8976), (353239, 9499), (362738, 8233), (370971, 8268), (379239, 8422), (387661, 8554), (396215, 8610), (404825, 8567), (413392, 9643), (423035, 8455), (431490, 8048), (439538, 8434), (447972, 8937), (456909, 8968), (465877, 8876), (474753, 9095), (483848, 8671), (492519, 9108), (501627, 8653), (510280, 8968), (519248, 7584), (526832, 8610), (535442, 8791), (544233, 8598), (552831, 9020), (561851, 8869), (570720, 8956), (579676, 8342), (588018, 9301), (597319, 9101), (606420, 8802), (615222, 8785), (624007, 8281), (632288, 7771), (640059, 9026), (649085, 8711), (657796, 9325), (667121, 8126), (675247, 9282), (684529, 8956), (693485, 8290), (701775, 9014), (710789, 7478), (718267, 8408), (726675, 8964), (735639, 8356), (743995, 8733), (752728, 9344), (762072, 8760), (770832, 8981), (779813, 8903), (788716, 9636), (798352, 8142), (806494, 8761), (815255, 8683), (823938, 8645), (832583, 9211), (841794, 8866), (850660, 8475), (859135, 8443), (867578, 8145), (875723, 8261), (883984, 8884), (892868, 8442), (901310, 8501), (909811, 8358), (918169, 9312), (927481, 9187), (936668, 9193), (945861, 9793), (955654, 9084), (964738, 9071), (973809, 9021), (982830, 8671), (991501, 8529), (1000030, 9065), (1009095, 8905), (1018000, 8609), (1026609, 8736), (1035345, 8503), (1043848, 9438), (1053286, 9245), (1062531, 9145), (1071676, 8733), (1080409, 8902), (1089311, 9812), (1099123, 8513), (1107636, 7901), (1115537, 9293), (1124830, 8694), (1133524, 10199), (1143723, 9207), (1152930, 8324), (1161254, 8911), (1170165, 8587), (1178752, 8453), (1187205, 8806), (1196011, 8259), (1204270, 9249), (1213519, 8280), (1221799, 8488), (1230287, 8928), (1239215, 9046), (1248261, 8034), (1256295, 8421), (1264716, 9077), (1273793, 8448), (1282241, 8472), (1290713, 8617), (1299330, 8401), (1307731, 9068), (1316799, 8814), (1325613, 8795), (1334408, 9147), (1343555, 8379), (1351934, 8802), (1360736, 8931), (1369667, 8363), (1378030, 8766), (1386796, 8199), (1394995, 7829), (1402824, 7938), (1410762, 8935), (1419697, 9367), (1429064, 8388), (1437452, 8387), (1445839, 9348), (1455187, 8591), (1463778, 8221), (1471999, 9210), (1481209, 8750), (1489959, 7824), (1497783, 8531), (1506314, 10113), (1516427, 8104), (1524531, 8266), (1532797, 9213), (1542010, 8567), (1550577, 9143), (1559720, 8460), (1568180, 8248), (1576428, 10888), (1587316, 8958), (1596274, 8694), (1604968, 8986), (1613954, 9708), (1623662, 9648), (1633310, 7938), (1641248, 8843), (1650091, 8193), (1658284, 8666), (1666950, 9426), (1676376, 8336), (1684712, 9055), (1693767, 8847), (1702614, 8640), (1711254, 8663), (1719917, 8383), (1728300, 8461), (1736761, 8820), (1745581, 8533), (1754114, 8873), (1762987, 8336), (1771323, 9254), (1780577, 8723), (1789300, 9383), (1798683, 9088), (1807771, 7817), (1815588, 9103), (1824691, 8454), (1833145, 8898), (1842043, 8920), (1850963, 9171), (1860134, 8732), (1868866, 9045), (1877911, 8860), (1886771, 8708), (1895479, 8736), (1904215, 8436), (1912651, 8742), (1921393, 9093), (1930486, 8807), (1939293, 8086), (1947379, 9803), (1957182, 8692), (1965874, 8633), (1974507, 8529), (1983036, 8688), (1991724, 8044), (1999768, 9072), (2008840, 8815), (2017655, 9553), (2027208, 8778), (2035986, 8242), (2044228, 9335), (2053563, 8630), (2062193, 9595), (2071788, 8301), (2080089, 8354), (2088443, 7700), (2096143, 9384), (2105527, 9039), (2114566, 9202), (2123768, 8497), (2132265, 8917), (2141182, 8548), (2149730, 9128), (2158858, 8423), (2167281, 7989), (2175270, 8598), (2183868, 8209), (2192077, 9082), (2201159, 9208), (2210367, 9114), (2219481, 8550), (2228031, 8677), (2236708, 8647)], [(2245355, 933), (2246288, 829), (2247117, 860), (2247977, 1024), (2249001, 712), (2249713, 861), (2250574, 659), (2251233, 1027), (2252260, 721), (2252981, 828), (2253809, 669), (2254478, 699), (2255177, 890), (2256067, 885), (2256952, 1090), (2258042, 1083), (2259125, 1348), (2260473, 762), (2261235, 1037), (2262272, 887), (2263159, 824), (2263983, 950), (2264933, 1017), (2265950, 838), (2266788, 828), (2267616, 784), (2268400, 1151), (2269551, 1350), (2270901, 842), (2271743, 887), (2272630, 1086), (2273716, 892), (2274608, 697), (2275305, 842), (2276147, 997), (2277144, 990), (2278134, 847), (2278981, 909), (2279890, 846), (2280736, 1225), (2281961, 741), (2282702, 1023), (2283725, 852), (2284577, 849), (2285426, 780), (2286206, 561), (2286767, 1108), (2287875, 1090), (2288965, 919), (2289884, 633), (2290517, 939), (2291456, 753), (2292209, 855), (2293064, 1128), (2294192, 1110), (2295302, 618), (2295920, 759), (2296679, 746), (2297425, 711), (2298136, 913), (2299049, 941), (2299990, 859), (2300849, 1202), (2302051, 1114), (2303165, 857), (2304022, 825), (2304847, 809), (2305656, 548), (2306204, 760), (2306964, 684), (2307648, 826), (2308474, 1015), (2309489, 713), (2310202, 897), (2311099, 700), (2311799, 807), (2312606, 714), (2313320, 815), (2314135, 901), (2315036, 602), (2315638, 948), (2316586, 724), (2317310, 1045), (2318355, 752), (2319107, 837), (2319944, 584), (2320528, 862), (2321390, 859), (2322249, 984), (2323233, 904), (2324137, 1110), (2325247, 1279), (2326526, 919), (2327445, 943), (2328388, 860), (2329248, 601), (2329849, 1023), (2330872, 947), (2331819, 704), (2332523, 779), (2333302, 895), (2334197, 1063), (2335260, 995), (2336255, 629), (2336884, 687), (2337571, 940), (2338511, 551), (2339062, 604), (2339666, 1099), (2340765, 1032), (2341797, 860), (2342657, 884), (2343541, 826), (2344367, 801), (2345168, 990), (2346158, 873), (2347031, 715), (2347746, 692), (2348438, 843), (2349281, 742), (2350023, 1170), (2351193, 814), (2352007, 957), (2352964, 570), (2353534, 849), (2354383, 1010), (2355393, 911), (2356304, 1081), (2357385, 785), (2358170, 1113), (2359283, 949), (2360232, 671), (2360903, 974), (2361877, 828), (2362705, 1014), (2363719, 828), (2364547, 796), (2365343, 776), (2366119, 865), (2366984, 688), (2367672, 775), (2368447, 765), (2369212, 824), (2370036, 651), (2370687, 635), (2371322, 637), (2371959, 750), (2372709, 728), (2373437, 824), (2374261, 728), (2374989, 824), (2375813, 631), (2376444, 618), (2377062, 935), (2377997, 825), (2378822, 778), (2379600, 835), (2380435, 1088), (2381523, 880), (2382403, 743), (2383146, 1115), (2384261, 903), (2385164, 705), (2385869, 888), (2386757, 1112), (2387869, 744), (2388613, 759), (2389372, 745), (2390117, 785), (2390902, 797), (2391699, 900), (2392599, 713), (2393312, 1016), (2394328, 864), (2395192, 972), (2396164, 972), (2397136, 837), (2397973, 663), (2398636, 814), (2399450, 787), (2400237, 2027), (2402264, 709), (2402973, 843), (2403816, 819), (2404635, 1147), (2405782, 938), (2406720, 863), (2407583, 684), (2408267, 704), (2408971, 1046), (2410017, 697), (2410714, 637), (2411351, 933), (2412284, 887), (2413171, 1004), (2414175, 874), (2415049, 830), (2415879, 763), (2416642, 908), (2417550, 809), (2418359, 939), (2419298, 832), (2420130, 896), (2421026, 716), (2421742, 834), (2422576, 723), (2423299, 995), (2424294, 993), (2425287, 802), (2426089, 1083), (2427172, 807), (2427979, 961), (2428940, 1006), (2429946, 1146), (2431092, 959), (2432051, 846), (2432897, 1054), (2433951, 806), (2434757, 633), (2435390, 490), (2435880, 908), (2436788, 906), (2437694, 631), (2438325, 1146), (2439471, 652), (2440123, 841), (2440964, 969), (2441933, 996), (2442929, 929), (2443858, 794), (2444652, 1007), (2445659, 819), (2446478, 984), (2447462, 736), (2448198, 725), (2448923, 619), (2449542, 698), (2450240, 486), (2450726, 883), (2451609, 1064), (2452673, 943), (2453616, 751), (2454367, 730), (2455097, 709), (2455806, 1046), (2456852, 636), (2457488, 655), (2458143, 1007), (2459150, 519), (2459669, 1033), (2460702, 2281), (2462983, 769), (2463752, 829), (2464581, 1003), (2465584, 1170), (2466754, 534)], [(2467288, 48), None, (2467336, 35), (2467371, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2467413, 42), None, (2467455, 25), (2467480, 44), (2467524, 22), (2467546, 18), None, None, None, None, (2467564, 26), None, None, None, None, (2467590, 21), (2467611, 25), None, None, (2467636, 26), None, None, None, None, (2467662, 71), (2467733, 21), (2467754, 23), None, None, None, None, (2467777, 48), None, None, None, None, None, (2467825, 31), None, None, None, None, (2467856, 42), None, (2467898, 22), None, (2467920, 21), None, (2467941, 26), (2467967, 42), None, None, (2468009, 77), (2468086, 27), None, None, None, None, (2468113, 21), (2468134, 21), None, None, (2468155, 34), (2468189, 42), None, None, None, (2468231, 25), None, None, (2468256, 21), None, None, None, None, None, (2468277, 24), (2468301, 21), None, None, (2468322, 26), None, (2468348, 18), None, (2468366, 54), None, None, None, None, None, None, (2468420, 26), None, None, None, (2468446, 20), None, None, (2468466, 64), (2468530, 42), (2468572, 17), (2468589, 17), (2468606, 26), None, (2468632, 26), None, None, None, (2468658, 26), (2468684, 20), (2468704, 26), None, (2468730, 42), (2468772, 63), None, None, None, (2468835, 40), (2468875, 48), None, None, None, (2468923, 47), None, None, None, None, None, None, None, (2468970, 42), None, (2469012, 80), None, (2469092, 9), None, (2469101, 21), (2469122, 42), None, None, (2469164, 65), (2469229, 82), (2469311, 21), None, (2469332, 72), None, None, (2469404, 24), (2469428, 21), None, None, None, None, None, (2469449, 42), (2469491, 21), (2469512, 21), None, (2469533, 42), (2469575, 25), None, (2469600, 38), (2469638, 21), (2469659, 56), None, None, (2469715, 21), (2469736, 19), (2469755, 26), None, (2469781, 16), None, (2469797, 21), None, None, (2469818, 38), None, (2469856, 22), (2469878, 21), (2469899, 21), (2469920, 21), None, (2469941, 63), None, (2470004, 21), (2470025, 42), None, (2470067, 17), None, None, None, None, (2470084, 21), (2470105, 21), None, None, (2470126, 21), None, None, (2470147, 21), None, (2470168, 26), None, (2470194, 50), (2470244, 22), None, None, (2470266, 50), (2470316, 26), (2470342, 21), (2470363, 21), (2470384, 19), None, (2470403, 35), (2470438, 26), (2470464, 23), (2470487, 39), (2470526, 42), None, None, None, None, None, None, (2470568, 21), None, None, None, (2470589, 21), None, None, (2470610, 90), None, (2470700, 239), (2470939, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
